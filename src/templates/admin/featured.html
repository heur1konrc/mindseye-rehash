{% extends "admin/base.html" %}

{% block title %}Featured Image Management - Mind's Eye Photography Admin{% endblock %}

{% block header %}Featured Image Management{% endblock %}

{% block head %}
<style>
    .featured-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .featured-item {
        border-radius: 8px;
        overflow: hidden;
        background-color: rgba(255, 255, 255, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .featured-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    
    .featured-image {
        width: 100%;
        aspect-ratio: 3/2;
        object-fit: cover;
    }
    
    .featured-content {
        padding: 15px;
    }
    
    .featured-title {
        font-size: 1.2rem;
        margin-bottom: 5px;
    }
    
    .featured-dates {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 10px;
    }
    
    .featured-story {
        font-size: 0.9rem;
        margin-bottom: 15px;
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
    }
    
    .featured-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .featured-status {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .featured-status.active {
        background-color: var(--success-color);
    }
    
    .featured-status.scheduled {
        background-color: var(--info-color);
    }
    
    .featured-status.expired {
        background-color: var(--secondary-bg);
    }
    
    .featured-action-buttons {
        display: flex;
        gap: 10px;
    }
    
    .featured-action-buttons button {
        background: none;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .featured-action-buttons button:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .featured-action-buttons button.edit-btn:hover {
        color: var(--primary-color);
    }
    
    .featured-action-buttons button.delete-btn:hover {
        color: var(--danger-color);
    }
    
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .image-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        aspect-ratio: 3/2;
        transition: transform 0.2s;
    }
    
    .image-item:hover {
        transform: scale(1.05);
    }
    
    .image-item.selected {
        border: 3px solid var(--primary-color);
    }
    
    .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .image-search {
        margin-bottom: 15px;
    }
    
    .story-editor {
        min-height: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-20">
    <div class="card-header">
        <h2>Current Featured Image</h2>
    </div>
    
    {% if current_featured %}
        <div class="featured-item">
            <img src="{{ url_for('static', filename=current_featured.image.filename) }}" alt="{{ current_featured.title }}" class="featured-image">
            <div class="featured-content">
                <h3 class="featured-title">{{ current_featured.title }}</h3>
                <div class="featured-dates">
                    {{ current_featured.start_date.strftime('%b %d, %Y') }} - {{ current_featured.end_date.strftime('%b %d, %Y') }}
                </div>
                <div class="featured-story">
                    {{ current_featured.story }}
                </div>
                <div class="featured-actions">
                    <span class="featured-status active">Active</span>
                    <div class="featured-action-buttons">
                        <button type="button" class="edit-btn" onclick="editFeatured({{ current_featured.id }})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="delete-btn" onclick="confirmDelete({{ current_featured.id }}, '{{ current_featured.title }}')">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="empty-state">
            <p>No active featured image. Set one below.</p>
        </div>
    {% endif %}
</div>

<div class="card mb-20">
    <div class="card-header">
        <h2>Set Featured Image</h2>
    </div>
    
    <form id="featuredForm" action="{{ url_for('admin.set_featured') }}" method="POST">
        <div class="form-group">
            <label for="image_id">Select Image</label>
            <div class="image-search">
                <input type="text" id="imageSearch" class="form-control" placeholder="Search images by title...">
            </div>
            <input type="hidden" id="image_id" name="image_id" required>
            <div id="imageGrid" class="image-grid">
                {% for image in images %}
                    <div class="image-item" data-id="{{ image.id }}" data-title="{{ image.title }}" onclick="selectImage({{ image.id }})">
                        <img src="{{ url_for('static', filename=image.filename) }}" alt="{{ image.title }}">
                    </div>
                {% endfor %}
            </div>
            <small>Click on an image to select it</small>
        </div>
        
        <div class="form-group">
            <label for="title">Title (optional)</label>
            <input type="text" id="title" name="title" class="form-control" placeholder="Leave blank to use image title">
        </div>
        
        <div class="form-group">
            <label for="story">Story</label>
            <textarea id="story" name="story" class="form-control story-editor" rows="6" placeholder="Tell the story behind this featured image..."></textarea>
        </div>
        
        <div class="grid">
            <div class="form-group">
                <label for="start_date">Start Date</label>
                <input type="date" id="start_date" name="start_date" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="end_date">End Date</label>
                <input type="date" id="end_date" name="end_date" class="form-control" required>
            </div>
        </div>
        
        <div class="text-right">
            <button type="submit" class="btn">Set as Featured</button>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-header">
        <h2>Scheduled Featured Images</h2>
    </div>
    
    <div class="featured-grid">
        {% for featured in scheduled_featured %}
            <div class="featured-item">
                <img src="{{ url_for('static', filename=featured.image.filename) }}" alt="{{ featured.title }}" class="featured-image">
                <div class="featured-content">
                    <h3 class="featured-title">{{ featured.title }}</h3>
                    <div class="featured-dates">
                        {{ featured.start_date.strftime('%b %d, %Y') }} - {{ featured.end_date.strftime('%b %d, %Y') }}
                    </div>
                    <div class="featured-story">
                        {{ featured.story }}
                    </div>
                    <div class="featured-actions">
                        <span class="featured-status scheduled">Scheduled</span>
                        <div class="featured-action-buttons">
                            <button type="button" class="edit-btn" onclick="editFeatured({{ featured.id }})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button type="button" class="delete-btn" onclick="confirmDelete({{ featured.id }}, '{{ featured.title }}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <p>No scheduled featured images.</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Edit Featured Modal -->
<div id="editModal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Edit Featured Image</h3>
            <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editFeaturedForm" action="" method="POST">
                <div class="form-group">
                    <label for="edit_title">Title (optional)</label>
                    <input type="text" id="edit_title" name="title" class="form-control" placeholder="Leave blank to use image title">
                </div>
                
                <div class="form-group">
                    <label for="edit_story">Story</label>
                    <textarea id="edit_story" name="story" class="form-control story-editor" rows="6"></textarea>
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="edit_start_date">Start Date</label>
                        <input type="date" id="edit_start_date" name="start_date" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_end_date">End Date</label>
                        <input type="date" id="edit_end_date" name="end_date" class="form-control" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" style="background-color: var(--secondary-bg);" onclick="closeEditModal()">Cancel</button>
            <button type="button" class="btn" onclick="submitEditForm()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Confirm Remove</h3>
            <button type="button" class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to remove "<span id="deleteFeaturedTitle"></span>" from featured images?</p>
            <p>This will not delete the image itself, only its featured status.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" style="background-color: var(--secondary-bg);" onclick="closeDeleteModal()">Cancel</button>
            <form id="deleteForm" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-danger">Remove</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates
        const today = new Date();
        const nextWeek = new Date();
        nextWeek.setDate(today.getDate() + 7);
        
        document.getElementById('start_date').value = formatDate(today);
        document.getElementById('end_date').value = formatDate(nextWeek);
        
        // Image search
        const imageSearch = document.getElementById('imageSearch');
        const imageItems = document.querySelectorAll('.image-item');
        
        imageSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            imageItems.forEach(function(item) {
                const title = item.dataset.title.toLowerCase();
                
                if (title.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
    
    // Format date as YYYY-MM-DD
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    }
    
    // Select image
    function selectImage(imageId) {
        // Remove selected class from all images
        document.querySelectorAll('.image-item').forEach(function(item) {
            item.classList.remove('selected');
        });
        
        // Add selected class to clicked image
        document.querySelector(`.image-item[data-id="${imageId}"]`).classList.add('selected');
        
        // Set image ID in hidden input
        document.getElementById('image_id').value = imageId;
    }
    
    // Edit featured image
    function editFeatured(featuredId) {
        // Fetch featured image data
        fetch(`{{ url_for('admin.get_featured', featured_id=0) }}`.replace('0', featuredId))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const featured = data.featured;
                    
                    // Set form action
                    document.getElementById('editFeaturedForm').action = `{{ url_for('admin.edit_featured', featured_id=0) }}`.replace('0', featuredId);
                    
                    // Fill form fields
                    document.getElementById('edit_title').value = featured.title || '';
                    document.getElementById('edit_story').value = featured.story || '';
                    document.getElementById('edit_start_date').value = featured.start_date;
                    document.getElementById('edit_end_date').value = featured.end_date;
                    
                    // Show modal
                    document.getElementById('editModal').style.display = 'flex';
                } else {
                    alert('Error fetching featured image: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while fetching featured image data.');
            });
    }
    
    // Close edit modal
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }
    
    // Submit edit form
    function submitEditForm() {
        document.getElementById('editFeaturedForm').submit();
    }
    
    // Delete confirmation
    function confirmDelete(featuredId, featuredTitle) {
        document.getElementById('deleteFeaturedTitle').textContent = featuredTitle;
        document.getElementById('deleteForm').action = `{{ url_for('admin.delete_featured', featured_id=0) }}`.replace('0', featuredId);
        document.getElementById('deleteModal').style.display = 'flex';
    }
    
    // Close delete modal
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }
</script>
{% endblock %}

